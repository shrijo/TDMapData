<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <title>Two Synced Maps</title>
    <!--
      Load the ArcGIS Maps SDK for JavaScript from CDN.
      Using version 4.33 which is the latest as of August 2025.
    -->
    <link rel="stylesheet" href="https://js.arcgis.com/4.33/esri/themes/light/main.css" />
    <script src="https://js.arcgis.com/4.33/"></script>
    <style>
      /* Reset all padding, margin, and borders to create the "two squares" look */
      html,
      body {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
        display: flex; /* Use flexbox to easily center the content */
        justify-content: center;
        align-items: center;
        flex-direction: column;
        background-color: #f3f4f6;
      }
      .map-container {
        width: 512px;
        height: 512px;
      }
    </style>
  </head>
  <body>
    <!-- The two map containers with no extra styling or titles -->
    <div id="view1Div" class="map-container"></div>
    <div id="view2Div" class="map-container"></div>

    <!-- The JavaScript logic -->
    <script>
      require([
        "esri/Map",
        "esri/views/MapView",
        "esri/layers/ImageryLayer",
        "esri/renderers/RasterStretchRenderer",
        "esri/core/reactiveUtils",
        "esri/identity/IdentityManager" // Added for authentication
      ], (Map, MapView, ImageryLayer, RasterStretchRenderer, reactiveUtils, IdentityManager) => {
        // This variable is a placeholder for your API key.
        // The platform will automatically populate it.
        const apiKey = "";
        
        // This is a necessary step for the canvas environment.
        // It tells the ArcGIS SDK to use the provided API key for all requests.
        IdentityManager.registerOAuthSession({
          serverUrl: "https://www.arcgis.com/sharing",
          token: apiKey
        });

        // --- Setup the Satellite Map View ---
        const satelliteMap = new Map({
          basemap: "satellite"
        });

        const satelliteView = new MapView({
          container: "view1Div",
          map: satelliteMap,
          center: [-118.805, 34.027],
          zoom: 13,
          // Add a loading indicator for better user experience
          ui: { components: ["attribution"] }
        });

        // --- Setup the DEM Heightmap View ---

        // Define a RasterStretchRenderer to make the DEM grayscale.
        const demRenderer = new RasterStretchRenderer({
          stretchType: "min-max",
          colorRamp: {
            type: "multipart",
            stops: [{
              color: [0, 0, 0, 255],
              value: 0
            }, {
              color: [255, 255, 255, 255],
              value: 4000
            }]
          }
        });

        // Create an ImageryLayer pointing to the World Elevation Terrain service.
        const demLayer = new ImageryLayer({
          url: "https://elevation.arcgis.com/arcgis/rest/services/WorldElevation/Terrain/ImageServer",
          renderer: demRenderer,
          format: "jpg"
        });

        // Create the map and add the DEM layer
        const demMap = new Map({
          layers: [demLayer]
        });

        const demView = new MapView({
          container: "view2Div",
          map: demMap,
          center: [-118.805, 34.027],
          zoom: 13,
          ui: { components: ["attribution"] }
        });

        // --- Sync the two views ---

        Promise.all([
          satelliteView.when(),
          demView.when()
        ]).then(() => {
          console.log("Both maps loaded and ready for synchronization.");
          const sync = (view1, view2) => {
            reactiveUtils.watch(
              () => view1.viewpoint,
              (viewpoint) => {
                view2.viewpoint = viewpoint;
              },
              { deep: true }
            );
          };

          sync(satelliteView, demView);
          sync(demView, satelliteView);
        }).catch(error => {
          console.error("An error occurred during map initialization:", error);
        });
      });
    </script>
  </body>
</html>

